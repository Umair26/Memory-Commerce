<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Listings - AI E-Commerce Platform</title>
  <link rel="stylesheet" href="/css/global.css">
  <script src="/js/common.js" defer></script>
  <style>
    .upload-hero {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-xl);
      margin-bottom: var(--spacing-xl);
    }

    .upload-hero h1 {
      font-size: 3em;
      margin-bottom: var(--spacing-md);
    }

    .subtitle {
      font-size: var(--font-size-lg);
      color: var(--text-secondary);
      margin-bottom: 0;
    }

    .upload-area {
      border: 3px dashed var(--primary-color);
      border-radius: var(--radius-xl);
      padding: 60px;
      text-align: center;
      background: var(--bg-light);
      cursor: pointer;
      transition: all var(--transition-normal);
      margin-bottom: var(--spacing-xl);
    }

    .upload-area:hover {
      background: #eef1ff;
      border-color: var(--primary-dark);
      transform: scale(1.01);
    }

    .upload-area.dragover {
      background: #e0e7ff;
      border-color: #4c51bf;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 5em;
      margin-bottom: var(--spacing-lg);
    }

    .upload-text {
      font-size: var(--font-size-xl);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      font-weight: 600;
    }

    .upload-hint {
      color: var(--text-muted);
      font-size: var(--font-size-base);
    }

    #fileInput {
      display: none;
    }

    .progress-container {
      display: none;
      margin: var(--spacing-xl) 0;
      background: white;
      padding: var(--spacing-xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .progress-container.active {
      display: block;
    }

    .results-container {
      display: none;
    }

    .results-container.active {
      display: block;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      background: white;
      padding: var(--spacing-xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .results-header h2 {
      font-size: var(--font-size-2xl);
      margin: 0;
    }

    .download-btn {
      padding: var(--spacing-md) var(--spacing-xl);
      background: var(--gradient-success);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: var(--font-size-base);
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .download-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }

    .results-table {
      background: white;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .original-text {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      padding: var(--spacing-sm);
      background: #fff3cd;
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-sm);
      border-left: 3px solid #ffc107;
    }

    .enhanced-text {
      color: var(--text-primary);
      font-weight: 500;
      padding: var(--spacing-sm);
      background: #d4edda;
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--secondary-color);
    }

    .improvement-badge {
      display: inline-block;
      padding: 6px 12px;
      background: var(--gradient-primary);
      color: white;
      border-radius: 20px;
      font-size: var(--font-size-sm);
      font-weight: 600;
      margin: 4px;
    }

    @media (max-width: 768px) {
      .upload-area {
        padding: 40px 20px;
      }

      .results-header {
        flex-direction: column;
        gap: var(--spacing-md);
        align-items: flex-start;
      }

      .download-btn {
        width: 100%;
      }

      .upload-hero h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">
        <span>üöÄ</span>
        <span>AI E-Commerce Platform</span>
      </a>
      <nav class="nav-links">
        <a href="/">Dashboard</a>
        <a href="/upload.html" class="active">Upload</a>
        <a href="/generator.html">Generator</a>
        <a href="/sheets.html">Sheets</a>
        <a href="/analytics.html">Analytics</a>
        <a href="/chat.html">Chat</a>
      </nav>
      <div class="menu-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Hero Section -->
    <div class="upload-hero">
      <h1>üì§ Upload & Enhance Listings</h1>
      <p class="subtitle">Upload your product CSV/Excel file and let AI enhance your listings with better titles, descriptions, and SEO keywords.</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Products Processed</div>
        <div class="stat-value" id="productsProcessed">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Improvements Made</div>
        <div class="stat-value" id="improvementsMade">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Time Saved</div>
        <div class="stat-value" id="timeSaved">0h</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Cost Savings</div>
        <div class="stat-value">75%</div>
      </div>
    </div>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Click to upload or drag & drop</div>
      <div class="upload-hint">Supports CSV and Excel files (.csv, .xlsx, .xls)</div>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div class="progress-text" id="progressText">Processing your listings...</div>
    </div>

    <!-- Results -->
    <div class="results-container" id="resultsContainer">
      <div class="results-header">
        <h2>‚ú® Enhanced Listings</h2>
        <button class="download-btn" id="downloadBtn">üì• Download Enhanced CSV</button>
      </div>

      <table class="results-table table" id="resultsTable">
        <thead>
          <tr>
            <th>Product</th>
            <th>Original vs Enhanced</th>
            <th>Improvements</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p class="footer-text">¬© 2025 AI E-Commerce Platform. All rights reserved.</p>
      <div class="footer-links">
        <a href="/about.html">About</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="mailto:support@example.com">Support</a>
      </div>
    </div>
  </footer>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsBody = document.getElementById('resultsBody');
    const downloadBtn = document.getElementById('downloadBtn');

    let enhancedData = [];

    // Upload area click
    uploadArea.addEventListener('click', () => fileInput.click());

    // Drag & drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFileUpload(file);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFileUpload(file);
    });

    // Handle file upload
    async function handleFileUpload(file) {
      console.log('Uploading file:', file.name);
      
      // Validate file type
      const validTypes = ['csv', 'xlsx', 'xls'];
      const fileExt = file.name.split('.').pop().toLowerCase();
      
      if (!validTypes.includes(fileExt)) {
        alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
      }
      
      // Show progress
      progressContainer.classList.add('active');
      resultsContainer.classList.remove('active');
      
      const formData = new FormData();
      formData.append('file', file);

      try {
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress <= 90) {
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
          }
        }, 200);

        const response = await fetch('/api/upload-listings', {
          method: 'POST',
          body: formData
        });

        clearInterval(progressInterval);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Upload failed');
        }

        const data = await response.json();
        
        // Complete progress
        progressFill.style.width = '100%';
        progressFill.textContent = '100%';
        progressText.textContent = '‚úÖ Processing complete!';

        // Store enhanced data
        enhancedData = data.enhanced;

        // Update stats with animation
        document.getElementById('productsProcessed').textContent = data.stats.processed;
        document.getElementById('improvementsMade').textContent = data.stats.improvements;
        document.getElementById('timeSaved').textContent = data.stats.timeSaved + 'h';

        // Display results
        setTimeout(() => {
          displayResults(data.enhanced);
          progressContainer.classList.remove('active');
          resultsContainer.classList.add('active');
          
          // Scroll to results
          resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 1000);

      } catch (error) {
        console.error('Upload error:', error);
        progressText.textContent = '‚ùå Error: ' + error.message;
        progressFill.style.background = '#ef4444';
        
        setTimeout(() => {
          progressContainer.classList.remove('active');
          alert('Error uploading file: ' + error.message);
        }, 2000);
      }
    }

    // Display results in table
    function displayResults(products) {
      resultsBody.innerHTML = '';
      
      if (!products || products.length === 0) {
        resultsBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px;">No products to display</td></tr>';
        return;
      }
      
      products.forEach((product, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>${escapeHtml(product.title || 'Product ' + (index + 1))}</strong>
          </td>
          <td>
            <div class="original-text">
              <strong>Original:</strong><br>
              ${escapeHtml(product.original.description || 'No description')}
            </div>
            <div class="enhanced-text">
              <strong>‚ú® Enhanced:</strong><br>
              ${escapeHtml(product.enhanced.description || 'Processing...')}
            </div>
          </td>
          <td>
            ${product.improvements.map(imp => `
              <span class="improvement-badge">${escapeHtml(imp)}</span>
            `).join(' ')}
          </td>
        `;
        resultsBody.appendChild(row);
      });
    }

    // Download enhanced CSV
    downloadBtn.addEventListener('click', () => {
      if (enhancedData.length === 0) {
        alert('No data to download');
        return;
      }

      try {
        // Convert to CSV using common.js function
        const csvData = enhancedData.map(item => item.enhanced);
        const csv = jsonToCSV(csvData);
        
        // Download
        downloadFile(csv, `enhanced_listings_${Date.now()}.csv`, 'text/csv');
        
        showSuccess('CSV downloaded successfully!');
      } catch (error) {
        console.error('Download error:', error);
        alert('Error downloading file: ' + error.message);
      }
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load initial stats
    updateStatsDisplay();
  </script>
</body>
</html>